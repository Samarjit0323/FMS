{% extends "faculty/dashboard.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}
  <div class="text-center my-5">
    <h3 class="fw-semibold mb-2" style="letter-spacing: 0.5px;">
      <i class="bi bi-folder2-open text-primary me-2"></i>
      Assignments Section
    </h3>
    <p class="text-muted" style="font-size: 0.95rem;">
      Track Assignments
    </p>
  </div>

<div class="container my-5">
  <div class="row g-4">
    
    <!-- Left: Upload Form -->
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0">Upload New Document</h5>
        </div>
        <div class="card-body p-4">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form | crispy }}
            <div class="d-flex justify-content-between align-items-center mt-4">

                <a href="{% url 'dashboard' faculty.user.username %}" class="btn btn-outline-secondary">
                    Back to Dashboard
                </a>
                
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-upload me-1"></i> Upload
                </button>

            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right: Uploaded Docs List -->
    <div class="col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Uploaded Assignments</h5>
          <small class="text-muted">Total: {{ docs_list.count }}</small>
        </div>

        <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
          {% if docs_list %}
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Title</th>
                <th scope="col">Uploaded On</th>
                <th scope="col">Submission Due</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for doc in docs_list %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="fw-semibold">{{ doc.title }}</td>
                <td>{{ doc.uploaded_on}}</td>
                <td>{{ doc.date_of_submission|date:"F j, Y" }}</td>
                <td class="text-end">
                  <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary me-2"> 
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16"> 
                      <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/> 
                      <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                    </svg> 
                  </a>

                  <a href="{{ doc.file.url }}" download class="btn btn-sm btn-outline-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-arrow-down" viewBox="0 0 16 16">
                      <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293z"/>
                      <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                    </svg>
                  </a>
                  <button type="button" class="btn btn-sm btn-outline-danger ml-2"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteDocModal"
                                            data-doc-id="{{ doc.id }}"
                                            data-doc-title="{{ doc.title }}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                      <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                    </svg>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="p-4 text-center text-muted">
            <i class="bi bi-folder2-open fs-1 d-block mb-2"></i>
            No documents uploaded yet.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="deleteDocModal" tabindex="-1" aria-labelledby="deleteDocModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDocModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this document?</p>
        <p class="fw-bold text-danger" id="doc-title-to-delete"></p>
        <small class="text-muted">This action cannot be undone.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a id="confirmDeleteBtn" href="#" class="btn btn-danger">Yes, Delete</a>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteDocModal');
    const docTitleElement = document.getElementById('doc-title-to-delete');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    deleteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const docId = button.getAttribute('data-doc-id');
        const docTitle = button.getAttribute('data-doc-title');

        docTitleElement.textContent = docTitle;
        
        // --- THIS IS THE FIX ---
        // Get the username from the Django template
        const username = "{{ faculty.user.username }}";
        
        // Build the correct URL to match your new path
        const deleteUrl = `/${username}/assignments/${docId}/delete/`; 
        
        confirmDeleteBtn.setAttribute('href', deleteUrl);
    });
    flatpickr(".datepicker", {
        altInput: true,       // Shows a nice, human-readable date
        altFormat: "F j, Y",  // How the date is displayed (e.g., "November 7, 2025")
        dateFormat: "Y-m-d",  // The actual format sent to Django
    });
});
</script>
{% endblock content %}
